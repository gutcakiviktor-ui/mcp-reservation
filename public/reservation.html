<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maison Concept Polaire — Réservation</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:#f6f7fb;margin:0;padding:24px}
    .wrap{max-width:980px;margin:0 auto}
    h1{font-size:34px;margin:0 0 12px}
    p.hint{color:#666;margin:0 0 20px}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(22,33,74,.06);padding:18px 18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    label{font-size:14px;color:#444}
    input,select{width:100%;box-sizing:border-box;padding:12px 14px;border:1px solid #d8dbe3;border-radius:10px;font-size:16px;background:#fff}
    .row{margin:12px 0}
    .total{height:44px;display:flex;align-items:center;justify-content:center;border-radius:10px;background:#f1f3f8;color:#111;font-weight:600;letter-spacing:.2px}
    .btn{display:inline-block;background:#2f64ff;color:#fff;border:none;border-radius:12px;padding:14px 18px;font-size:16px;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:#6b7280;font-size:14px}
    .danger{background:#ea4335}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Maison Concept Polaire — Réservation</h1>
  <p class="hint">Choisissez vos dates et le logement. Le montant s'actualise automatiquement.</p>

  <div class="card">
    <div class="grid">
      <div class="row">
        <label>Logement</label>
        <select id="logement">
          <option value="apartment">Appartement</option>
          <option value="house">Maison</option>
        </select>
      </div>

      <div class="row">
        <label>Date d'arrivée</label>
        <input id="dateStart" type="date" />
      </div>

      <div class="row">
        <label>Date de départ</label>
        <input id="dateEnd" type="date" />
      </div>

      <div class="row">
        <label>Adultes</label>
        <input id="adults" type="number" min="1" value="2" />
      </div>

      <div class="row">
        <label>Enfants (≥2 ans)</label>
        <input id="kids" type="number" min="0" value="0" />
      </div>

      <div class="row">
        <label>Bébés (&lt;2 ans)</label>
        <input id="babies" type="number" min="0" value="0" />
      </div>

      <div class="row">
        <label>Nom (optionnel)</label>
        <input id="name" type="text" placeholder="Nom Prénom"/>
      </div>

      <div class="row">
        <label>Email (pour le reçu)</label>
        <input id="email" type="email" placeholder="nom@example.com"/>
      </div>
    </div>

    <div class="row">
      <div id="summary" class="total">Calcul en cours…</div>
    </div>

    <div class="row">
      <button id="payBtn" class="btn">Payer maintenant</button>
      <span class="muted" id="policy"></span>
    </div>
  </div>

  <p class="muted" style="margin:16px 2px 0">
    Annulation : &gt;30 jours — remboursement intégral ; 15–30 jours — 50 % ; &lt;15 jours — non remboursable.
    Réservation de dernière minute (≤7 jours) — paiement 100 % non remboursable.
  </p>
</div>

<script>
/* ====== paramètres facilement éditables ====== */
const PRICES = {
  apartment: { perNight: 60, cleaning: 0 },   // Appartement
  house:     { perNight: 150, cleaning: 50 }  // Maison
};
const EXTRA_GUEST_PER_NIGHT = 15;   // invité supplémentaire (au-delà de 2 pers.)
const CITY_TAX_PER_PERSON   = 1.20; // taxe de séjour, par nuit, par adulte (≥2 ans)

/* ====== helpers ====== */
const $ = id => document.getElementById(id);
const fmt = v => v.toFixed(2).replace('.', ',') + ' €';

function parseDate(v){ const d = new Date(v+'T00:00:00'); if(isNaN(d)) return null; return d; }
function nightsBetween(a,b){return Math.max(0, Math.round((b-a)/(1000*60*60*24)));}

/* ====== UI elements ====== */
const els = {
  logement: $('logement'),
  start: $('dateStart'),
  end: $('dateEnd'),
  adults: $('adults'),
  kids: $('kids'),
  babies: $('babies'),
  name: $('name'),
  email: $('email'),
  summary: $('summary'),
  payBtn: $('payBtn'),
  policy: $('policy'),
};

/* init dates (aujourd'hui + demain) */
(function initDates(){
  const today = new Date();
  const tom = new Date(Date.now()+86400000);
  els.start.value = today.toISOString().slice(0,10);
  els.end.value = tom.toISOString().slice(0,10);
})();

/* calcul */
function compute(){
  const lg = els.logement.value;
  const start = parseDate(els.start.value);
  const end   = parseDate(els.end.value);
  const nights = (start && end) ? nightsBetween(start,end) : 0;

  const adults = Math.max(1, +els.adults.value||1);
  const kids   = Math.max(0, +els.kids.value||0);
  const babies = Math.max(0, +els.babies.value||0);
  const persons = adults + kids; // bébés gratuits

  const base = PRICES[lg];
  const baseNights = nights * base.perNight;
  const extraGuests = Math.max(0, persons - 2);
  const extra = extraGuests * EXTRA_GUEST_PER_NIGHT * nights;
  const cleaning = base.cleaning;
  const cityTax = CITY_TAX_PER_PERSON * adults * nights;

  const total = baseNights + extra + cleaning + cityTax;

  // règle d'acompte: >7 jours до заезда — 50%, иначе 100%
  const daysToArrival = Math.round((parseDate(els.start.value) - new Date())/(1000*60*60*24));
  const payNowRatio = (daysToArrival <= 7) ? 1 : 0.5;
  const payNow = total * payNowRatio;

  els.summary.textContent =
    `Hébergement: ${fmt(baseNights)}  ·  Suppléments: ${fmt(extra)}  ·  Ménage: ${fmt(cleaning)}  ·  Taxe: ${fmt(cityTax)}  →  À payer maintenant: ${fmt(payNow)}`;

  els.policy.textContent = (payNowRatio === 1)
    ? 'Réservation ≤ 7 jours : paiement 100 % à la réservation — non remboursable.'
    : 'Acompte 50 % maintenant, le solde 7 jours avant l’arrivée.';

  return { nights, total, payNow, payNowRatio };
}

['change','input'].forEach(ev=>{
  document.addEventListener(ev, e=>{
    if(['INPUT','SELECT'].includes(e.target.tagName)) compute();
  });
});
compute();

/* paiement */
els.payBtn.addEventListener('click', async ()=>{
  els.payBtn.disabled = true;
  try{
    const calc = compute();
    const payload = {
      amountToPay: +calc.payNow.toFixed(2),
      description: (els.logement.value==='house'?'Maison':'Appartement')
                   + ` · ${els.start.value} → ${els.end.value} · ${els.adults.value} adultes`,
      customerEmail: els.email.value || undefined
    };
    const res = await fetch('/.netlify/functions/checkout', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      const t = await res.text();
      throw new Error(t || ('HTTP '+res.status));
    }
    const data = await res.json();
    if(!data.url) throw new Error('Réponse inattendue du serveur');
    window.location.href = data.url;
  }catch(err){
    alert('Erreur: ' + (err.message || err));
  }finally{
    els.payBtn.disabled = false;
  }
});
</script>
</body>
</html>

